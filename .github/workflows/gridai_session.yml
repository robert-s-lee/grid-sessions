name: "gridai-session"

on:
  # push:
  pull_request:  
  schedule:
  # run at 3 min past the hour every day
  # MIN HOUR DOM MON DOW CMD
    - cron: 3 * * * *

jobs:
  gridai-session:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8' # min version supported by Grid.ai
      - run: |
          ssh-keygen -t ed25519 -C "sangkyulee@gmail.com" -N "" -f ~/.ssh/id_ed25519
      - run: |
          python -m pip install --upgrade pip
      - run: |
          pip install lightning-grid --upgrade
      - run: |
          grid login --username ${{ secrets.GRIDAI_USERNAME }} --key ${{ secrets.GRIDAI_KEY }}
          export DT=$(date '+%y%m%d-%H%M%S')
          export GRIDAI_SESSION_PREFIX=test
          export GRIDAI_SESSION_NAME="${GRIDAI_SESSION_PREFIX}-${DT}"
          echo "GRIDAI_SESSION_NAME=${GRIDAI_SESSION_NAME}" >> $GITHUB_ENV
      - run: |
          grid session create --use_spot --name ${GRIDAI_SESSION_NAME} | tee grid.session.log
          SESSION_NAME=$(grep " name: " grid.session.log | cut -d':' -f 2 | sed -e 's/^[[:space:]]*//')
          if [[ "${GRIDAI_SESSION_NAME}" != "${SESSION_NAME}"" ]]; then
            echo "Error: ${GRIDAI_SESSION_NAME} requested but ${SESSION_NAME} was created"
          fi
          echo "SESSION_NAME=${SESSION_NAME}" >> $GITHUB_ENV
      - run: |
          SESSION_STATUS=$(grid session | grep " ${SESSION_NAME} " | awk '{print $4}')
          # pool at 1 min interval
          while [ "${SESSION_STATUS}" != 'running' ]; do 
            echo "${SESSION_NAME}:${SESSION_STATUS} waiting 60 sec for the next status"
            sleep 60 
            SESSION_STATUS=$(grid session | grep " ${SESSION_NAME} " | awk '{print $4}')
          done
          case ${SESSION_STATUS} in
            running)
              ;;
            *)
              echo "Error: ${SESSION_NAME} did not start"
              exit 1
          esac
      - run: |
          grid ssh-keys add lit_key ~/.ssh/id_ed25519.pub
      - run: |
          grid session ssh ${SESSION_NAME} "ls; exit"